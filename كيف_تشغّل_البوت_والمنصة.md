# كيف تشغّل البوت والمنصة

## 0) تشغيل بنقرة واحدة (موصى به)

من جذر المشروع (المجلد الذي فيه `start.ps1` و `backend` و `dashboard_v2`):

```powershell
.\start.ps1
```

السكربت:
- يتحقق من وجود `backend\.env` و `dashboard_v2\.env` (وينشئهما من `.env.example` إن لم يكونا موجودين)
- يفرض **وضع التجريبي (Demo)** و **Paused** عند كل تشغيل في `runtime_config.json`
- يزامن `VITE_API_URL` في المنصة مع منفذ البوت تلقائياً
- يحرّر المنفذ إن كان مستخدماً ثم يشغّل البوت في **نافذة جديدة**
- ينتظر حتى يصبح الـ API جاهزاً (حتى 30 ثانية)
- يشغّل المنصة في النافذة الحالية
- اضغط **Ctrl+C** في نافذة المنصة للإيقاف؛ البوت يبقى يعمل في النافذة الأخرى حتى تغلقها

ثم افتح المتصفح على: **http://localhost:5173**

---

## 1) تشغيل البوت (Backend) — يدوياً

1. افتح **طرفية (Terminal)** في مجلد المشروع.
2. انتقل لمجلد البوت:
   ```bash
   cd backend
   ```
3. إذا لم يكن موجودًا، أنشئ ملف `.env` من المثال:
   ```bash
   copy .env.example .env
   ```
4. عدّل `.env` وضَع على الأقل:
   - `AURORA_ADMIN_TOKEN=كلمة_سر_قوية_تختارها_أنت`
   - المنفذ الافتراضي في `.env.example` هو `127.0.0.1:3001` (غيّره إن احتجت)
5. شغّل البوت:
   ```bash
   cargo run
   ```
6. انتظر حتى تظهر رسالة مثل: **API listening on 127.0.0.1:3001** (أو المنفذ الذي ضبطته في `.env`)

---

## 2) تشغيل المنصة (Dashboard)

1. افتح **طرفية ثانية** (اترك البوت يعمل في الأولى).
2. انتقل لمجلد المنصة:
   ```bash
   cd dashboard_v2
   ```
3. إذا لم تكن ثُمّنت الحزم من قبل:
   ```bash
   npm install
   ```
4. أنشئ ملف `.env` في `dashboard_v2` وضَع فيه:
   - `VITE_API_URL=http://127.0.0.1:3001`  (نفس المنفذ الذي يعمل عليه البوت)
   - `VITE_ADMIN_TOKEN=نفس_كلمة_السر_التي_في_البوت`
5. شغّل المنصة:
   ```bash
   npm run dev
   ```
6. افتح المتصفح على: **http://localhost:5173**

---

## 3) التحقق أن كل شيء مربوط

- في المنصة يجب أن يظهر في الهيدر: **System: GREEN** و **Mode** و **State** و **Seq** (أرقام تتغير).
- إذا ظهر بانر أحمر "API: 403..." فالتوكن غير مطابق أو غير مضبوط في `.env` بالمنصة.
- من صفحة **Control** يمكنك:
  - تغيير **وضع الحساب**: **Demo (تجريبي)** ↔ **Live (حقيقي)** مع تأكيد عند التبديل إلى Live.
  - استخدام **Pause** / **Resume** / **Kill Switch**.

---

## 4) أوامر تحقق سريعة (من طرفية ثالثة)

```bash
# بدون توكن — يجب أن يعمل
curl http://127.0.0.1:3001/api/v1/health

# مع توكن — يجب أن يرجع state كامل
curl -H "Authorization: Bearer YOUR_TOKEN" http://127.0.0.1:3001/api/v1/state
```

استبدل `YOUR_TOKEN` بنفس قيمة `AURORA_ADMIN_TOKEN` في `.env` الخاص بالبوت.

---

## خطأ: المنفذ مستخدم (10048 — Port already in use)

إذا ظهر: **Only one usage of each socket address is normally permitted (os error 10048)** فمعناه أن منفذ البوت (مثلاً 3001) مستخدم — غالباً نسخة سابقة من البوت لا تزال تعمل.

**الحل (اختر أحدها):**

1. **استخدم السكربت الموحّد** — يحرّر المنفذ تلقائياً ثم يشغّل البوت:
   ```powershell
   .\start.ps1
   ```

2. **أوقف العملية يدوياً ثم شغّل البوت:**
   ```powershell
   .\stop-bot.ps1
   .\backend\target\release\aurora-bot.exe
   ```
   أو أمر واحد لتحرير المنفذ فقط:
   ```powershell
   Get-NetTCPConnection -LocalPort 3001 -ErrorAction SilentlyContinue | ForEach-Object { Stop-Process -Id $_.OwningProcess -Force -ErrorAction SilentlyContinue }
   ```
   (غيّر `3001` إذا استخدمت منفذاً آخر في `backend\.env`.)

ثم شغّل البوت مرة أخرى.

---

## ملخص المنافذ

| الخدمة   | العنوان الافتراضي        |
|----------|---------------------------|
| الخدمة   | العنوان الافتراضي          |
|----------|-----------------------------|
| البوت    | http://127.0.0.1:3001       |
| المنصة   | http://localhost:5173      |

إذا غيّرت منفذ البوت في `backend/.env`، شغّل `.\start.ps1` مرة واحدة ليمزامن `VITE_API_URL` في المنصة تلقائياً، أو غيّر يدوياً في `dashboard_v2/.env`.

---

## بناء البوت (بدون إيقاف يدوي)

إذا ظهر عند البناء **Access is denied** لأن البوت يعمل، استخدم السكربت الموحّد — يوقف البوت تلقائياً ثم يبني:

```powershell
.\build.ps1
```

ثم شغّل البوت والمنصة بـ `.\start.ps1`.

---

## خطأ Arena API 404

إذا ظهر في صفحة Strategy: **Arena API 404** أو **Arena API not found**:
1. تأكد أن البوت مُبني بالإصدار الذي فيه Arena: من مجلد المشروع نفّذ `.\build.ps1` (أو `cd backend; cargo build --release` بعد إيقاف البوت)
2. أعد تشغيل البوت ثم المنصة (أو `.\start.ps1`)
3. تأكد أن `VITE_API_URL` في `dashboard_v2/.env` يشير لنفس منفذ البوت (أو شغّل `.\start.ps1` ليمزامنها)

---

## ربط Binance للبيانات الحية (Regime، Klines، إلخ)

بدون مفاتيح Binance، المنصة تعمل لكن **Market Regime** و **Signal Ensemble** تبقى "No data yet" لأن البوت لا يستقبل شموعاً.

لتفعيل البيانات الحية (مع بقاء الحساب في وضع **Demo** للتجربة):
1. من [Binance](https://www.binance.com/) أنشئ API Key (للمراقبة فقط إن أردت؛ أو مع تداول للـ Live لاحقاً)
2. في `backend/.env` أزل التعليق وضَع:
   ```env
   BINANCE_API_KEY=your_api_key_here
   BINANCE_SECRET=your_secret_here
   ```
3. أعد تشغيل البوت — سيملأ الشموع ويحسب Regime والإشارات
4. بقي الحساب في **Demo** حتى تغيّر الوضع من صفحة Control إلى Live بعد التأكد
